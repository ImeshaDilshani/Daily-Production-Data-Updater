<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Export and Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        #data-table {
            display: none;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Production Data Export and Display</h2>
    <button id="fetch-data-btn">Fetch and Display Data</button>
    <button id="download-excel-btn">Download as Excel</button>
    <div id="eptNumberOptions" class="eptNumber-Options"></div>
    <div id="productionDivisionOptions" class="productionDivision-Options"></div>

    <!-- Table to Display Fetched Data -->
    <table id="data-table">
        <thead id="table-header">
            <!-- Headers will be inserted here dynamically -->
        </thead>
        <tbody id="table-body">
            <!-- Data will be inserted here dynamically -->
        </tbody>
    </table>

    <script>
        document.getElementById('fetch-data-btn').addEventListener('click', async () => {
            try {
                // Fetch data from the API
                const response = await fetch('http://localhost:5000/api/get-data');
                const data = await response.json();

                if (data && data.length > 0) {
                    const tableBody = document.getElementById('table-body');
                    const tableHeader = document.getElementById('table-header');
                    tableBody.innerHTML = '';
                    tableHeader.innerHTML = '';

                    // Define array columns with a maximum of 6 columns per array attribute
                    const arrayColumns = [
                        'sap_code',
                        'packing_qty',
                        'packing_hrs',
                        'additional_action',
                        'loss_time_normal_hrs',
                        'loss_time_ot',
                        'packing_item',
                        'packing_type'
                    ];
                    const maxColumns = 6;

                    // Create table header dynamically
                    let columnHeaders = `
                        <tr>
                            <th>EPF Number</th>
                            <th>Date of Production</th>
                            <th>Production Division</th>
                    `;

                    // Create headers for each array column up to maxColumns
                    arrayColumns.forEach(column => {
                        for (let i = 0; i < maxColumns; i++) {
                            columnHeaders += `<th>${column}_${i + 1}</th>`;
                        }
                    });
                    columnHeaders += `</tr>`;
                    tableHeader.innerHTML = columnHeaders;

                    // Populate the table rows with data
                    data.forEach(item => {
                        let row = `
                            <tr>
                                <td>${item.epf_number}</td>
                                <td>${item.date_of_production}</td>
                                <td>${item.production_division}</td>
                        `;

                        // Insert data for each array column
                        arrayColumns.forEach(column => {
                            // Loop through up to maxColumns for each array attribute
                            for (let i = 0; i < maxColumns; i++) {
                                row += `<td>${item[column] && item[column][i] ? item[column][i] : ''}</td>`;
                            }
                        });

                        row += `</tr>`;
                        tableBody.innerHTML += row;
                    });

                    // Show the table after populating data
                    document.getElementById('data-table').style.display = 'table';
                } else {
                    alert('No data found!');
                }
            } catch (err) {
                console.error('Error fetching data:', err);
                alert('Failed to fetch data');
            }
        });

        // Function to download the Excel file
        document.getElementById('download-excel-btn').addEventListener('click', () => {
            // Create an invisible link element to download the file
            const link = document.createElement('a');
            link.href = 'http://localhost:5000/api/export-excel';
            link.setAttribute('download', 'production_data.xlsx');
            document.body.appendChild(link);

            // Programmatically click the link to trigger the download
            link.click();

            // Clean up the link after downloading
            document.body.removeChild(link);
        });

        // Fetch EPF numbers and populate EPF number dropdown
        fetch('http://127.0.0.1:5000/api/employees/epf-number')
            .then(response => response.json())
            .then(data => {
                const eptNumberOptions = document.getElementById('eptNumberOptions');
                const select = document.createElement('select');
                select.id = 'epfSelect';
                eptNumberOptions.appendChild(select);

                // Create default "Select EPF Number" option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select EPF Number';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                // Add fetched EPF numbers to the dropdown list
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.epf_number;
                    option.textContent = item.epf_number;
                    select.appendChild(option);
                });

                // Event listener to handle selection of EPF number
                select.addEventListener('change', () => {
                    console.log('Selected EPF Number:', select.value);
                });
            })
            .catch(error => console.error('Error fetching EPF numbers:', error));
    </script>
</body>
</html>
